<!DOCTYPE html>
<html lang="hi" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Basic Styles */
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-thin::-webkit-scrollbar { width: 5px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #888; border-radius: 5px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Light Theme */
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --message-sent-bg: #dcf8c6;
            --message-received-bg: #ffffff;
            --icon-color: #64748b;
        }

        /* Dark Theme */
        html.dark {
            --bg-primary: #0b1426;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --message-sent-bg: #056162;
            --message-received-bg: #334155;
            --icon-color: #94a3b8;
        }

        /* Apply Theme Variables */
        body { background-color: var(--bg-primary); color: var(--text-primary); }
        .bg-theme-secondary { background-color: var(--bg-secondary); }
        .bg-theme-tertiary { background-color: var(--bg-tertiary); }
        .text-theme-primary { color: var(--text-primary); }
        .text-theme-secondary { color: var(--text-secondary); }
        .border-theme { border-color: var(--border-color); }
        .message-bubble-sent { background-color: var(--message-sent-bg); }
        .message-bubble-received { background-color: var(--message-received-bg); }
        .icon-theme { color: var(--icon-color); }
        .hover\:bg-theme-tertiary:hover { background-color: var(--bg-tertiary); }

        /* Other Styles */
        .message-content img, .message-content video { max-width: 300px; border-radius: 0.5rem; }
        .toggle-checkbox:checked { right: 0; border-color: #48bb78; }
        .toggle-checkbox:checked + .toggle-label { background-color: #48bb78; }
    </style>
</head>
<body class="bg-theme-primary">

    <div id="loading-spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
    </div>

    <div id="maintenance-screen" class="hidden fixed inset-0 bg-theme-primary flex flex-col items-center justify-center text-center p-4 z-40">
        <i class="fas fa-tools text-6xl text-theme-secondary mb-4"></i>
        <h1 class="text-3xl font-bold text-theme-primary">Site Under Maintenance</h1>
        <p class="text-theme-secondary mt-2">We are currently performing maintenance. We will be back shortly. Thank you for your patience.</p>
    </div>

    <div id="auth-screen" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full bg-theme-secondary p-8 rounded-lg shadow-lg">
            <h2 id="auth-title" class="text-2xl font-bold text-center text-theme-primary mb-6">Login</h2>
            <form id="auth-form">
                <input id="email" type="email" placeholder="Email" class="w-full px-4 py-2 mb-4 border border-theme bg-theme-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <input id="password" type="password" placeholder="Password" class="w-full px-4 py-2 mb-4 border border-theme bg-theme-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <button type="submit" id="auth-button" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition duration-200">Login</button>
            </form>
            <p id="auth-error" class="text-center text-sm text-red-500 mt-2 hidden"></p>
            <p class="text-center text-sm text-theme-secondary mt-4">
                <span id="auth-toggle-text">Don't have an account?</span>
                <a href="#" id="auth-toggle-link" class="text-blue-500 hover:underline">Sign Up</a>
            </p>
        </div>
    </div>
    
    <div id="main-app" class="hidden h-screen w-full md:flex">
        <div id="chat-list-container" class="w-full md:w-1/3 lg:w-1/4 bg-theme-secondary border-r border-theme flex flex-col">
            <div class="p-4 border-b border-theme flex justify-between items-center">
                <h2 class="text-xl font-bold">Chats</h2>
                <div id="user-profile" class="relative">
                    <img id="user-avatar" src="https://placehold.co/40x40/EFEFEF/AAAAAA&text=U" class="w-10 h-10 rounded-full cursor-pointer">
                    <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-theme-secondary rounded-md shadow-lg py-1 z-20 border border-theme">
                        <a href="#" id="theme-toggle-button" class="block px-4 py-2 text-sm text-theme-primary hover:bg-theme-tertiary"><i class="fas fa-sun mr-2"></i><span>Switch to Dark Mode</span></a>
                        <a href="#" id="admin-panel-button" class="hidden block px-4 py-2 text-sm text-theme-primary hover:bg-theme-tertiary"><i class="fas fa-user-shield mr-2"></i>Admin Panel</a>
                        <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-theme-primary hover:bg-theme-tertiary"><i class="fas fa-sign-out-alt mr-2"></i>Logout</a>
                    </div>
                </div>
            </div>
            
            <div class="p-2 border-b border-theme">
                 <button id="chat-with-admin-btn" class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition duration-200 flex items-center justify-center">
                    <i class="fas fa-headset mr-2"></i> Chat with Support
                </button>
            </div>

            <div id="user-list" class="flex-1 overflow-y-auto scrollbar-thin">
            </div>
        </div>

        <div id="chat-window-wrapper" class="flex-1 flex-col bg-theme-primary hidden md:flex">
            <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center">
                <i class="fas fa-comments text-6xl text-gray-400"></i>
                <h2 class="mt-4 text-2xl font-semibold text-theme-primary">Welcome to Chat App</h2>
                <p class="text-theme-secondary">Select a chat to start messaging</p>
            </div>
            
            <div id="chat-window" class="hidden flex-1 flex flex-col h-full">
                <div class="flex items-center justify-between p-3 border-b border-theme bg-theme-secondary">
                    <div class="flex items-center">
                        <button id="back-to-chats-btn" class="md:hidden mr-4 p-2 text-theme-secondary hover:text-theme-primary"><i class="fas fa-arrow-left text-xl"></i></button>
                        <img id="chat-header-avatar" src="https://placehold.co/48x48" class="w-12 h-12 rounded-full mr-4">
                        <div>
                            <h3 id="chat-header-name" class="font-semibold text-lg"></h3>
                            <p id="chat-header-status" class="text-sm text-green-500"></p>
                        </div>
                    </div>
                    <button id="delete-chat-btn" class="p-2 text-theme-secondary hover:text-red-500"><i class="fas fa-trash-alt text-xl"></i></button>
                </div>

                <div id="messages-container" class="flex-1 p-4 overflow-y-auto scrollbar-thin">
                </div>

                <div class="bg-theme-secondary p-4 border-t border-theme">
                    <div id="emoji-picker" class="hidden grid grid-cols-8 gap-2 p-2 bg-theme-tertiary rounded-lg mb-2">
                    </div>
                    <div class="flex items-center">
                        <button id="emoji-btn" class="mr-2 p-2 icon-theme hover:text-blue-500"><i class="fas fa-smile text-xl"></i></button>
                        <input id="message-input" type="text" placeholder="Type a message..." class="flex-1 px-4 py-2 border border-theme bg-theme-secondary rounded-full focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <button id="attach-file-btn" class="ml-2 p-2 icon-theme hover:text-blue-500"><i class="fas fa-paperclip text-xl"></i></button>
                        <input type="file" id="file-input" class="hidden" accept="image/*,video/*">
                        <button id="record-voice-btn" class="ml-2 p-2 icon-theme hover:text-red-500"><i class="fas fa-microphone text-xl"></i></button>
                        <button id="send-btn" class="ml-2 bg-blue-500 text-white px-5 py-2 rounded-full hover:bg-blue-600"><i class="fas fa-paper-plane"></i></button>
                    </div>
                    <p id="recording-status" class="text-xs text-red-500 mt-1 hidden"><i class="fas fa-circle text-red-500 animate-pulse"></i> Recording...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="admin-panel" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-30 p-4">
        <div class="bg-theme-secondary rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-theme">
                <h3 class="text-xl font-bold"><i class="fas fa-user-shield mr-2"></i>Admin Panel</h3>
                <button id="close-admin-panel" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <div class="w-1/4 border-r border-theme p-2">
                    <nav class="flex flex-col space-y-1">
                        <a href="#settings" class="admin-tab-link bg-theme-tertiary text-theme-primary font-semibold flex items-center px-3 py-2 rounded-md"><i class="fas fa-cog mr-3"></i>Settings</a>
                        <a href="#users" class="admin-tab-link text-theme-secondary hover:bg-theme-tertiary hover:text-theme-primary flex items-center px-3 py-2 rounded-md"><i class="fas fa-users mr-3"></i>Users</a>
                        <a href="#content" class="admin-tab-link text-theme-secondary hover:bg-theme-tertiary hover:text-theme-primary flex items-center px-3 py-2 rounded-md"><i class="fas fa-photo-video mr-3"></i>Content</a>
                    </nav>
                </div>
                 <div class="w-3/4 p-4 overflow-y-auto">
                    <div id="admin-tab-settings" class="admin-tab-content">
                        <h4 class="text-lg font-semibold mb-2">Site Settings</h4>
                        <div class="space-y-4 p-4 bg-theme-tertiary rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="font-medium text-theme-primary">Maintenance Mode</label>
                                    <p class="text-sm text-theme-secondary">Put the site offline for non-admins.</p>
                                </div>
                                <div class="flex items-center">
                                    <span id="maintenance-status-text" class="text-sm font-semibold mr-3">OFF</span>
                                    <div class="relative inline-block w-12 align-middle select-none">
                                        <input type="checkbox" name="maintenance-toggle" id="maintenance-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                        <label for="maintenance-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <h4 class="text-lg font-semibold mt-6 mb-2">Security</h4>
                        <div class="space-y-4 p-4 bg-theme-tertiary rounded-lg">
                             <div class="flex items-center justify-between">
                                <div>
                                    <label class="font-medium text-theme-primary">Allow New Registrations</label>
                                    <p class="text-sm text-theme-secondary">Allow new users to sign up.</p>
                                </div>
                                <div class="flex items-center">
                                    <span id="registration-status-text" class="text-sm font-semibold mr-3">ON</span>
                                    <div class="relative inline-block w-12 align-middle select-none">
                                        <input type="checkbox" name="registration-toggle" id="registration-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                        <label for="registration-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div id="admin-tab-users" class="admin-tab-content hidden">
                         <h4 class="text-lg font-semibold mb-2">Manage Users</h4>
                        <div id="admin-user-list" class="space-y-2">
                            </div>
                    </div>
                     <div id="admin-tab-content" class="admin-tab-content hidden">
                         <h4 class="text-lg font-semibold mb-2">Content Management</h4>
                         <div class="p-4 bg-theme-tertiary rounded-lg text-center">
                            <p class="text-theme-secondary">This is where you would manage sticker packs, emojis, and other app content. This feature is not yet implemented.</p>
                            <button class="mt-4 bg-blue-500 text-white py-2 px-4 rounded-lg opacity-50 cursor-not-allowed">Upload Stickers</button>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase and Cloudinary Configurations
        const firebaseConfig = {
            apiKey: "AIzaSyD86N7zF7rm_0_E_PuoSdD6cwQTGmIlL7s",
            authDomain: "dekha-5daeb.firebaseapp.com",
            databaseURL: "https://dekha-5daeb-default-rtdb.firebaseio.com",
            projectId: "dekha-5daeb",
            storageBucket: "dekha-5daeb.firebasestorage.app",
            messagingSenderId: "647841969799",
            appId: "1:647841969799:web:c133fdc1cc8ea986846a22"
        };
        const cloudinaryConfig = { cloud_name: "dl4rnmjyn", upload_preset: "chatting" };
        const ADMIN_EMAIL = "admin@example.com";

        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, addDoc, serverTimestamp, orderBy, getDocs, writeBatch, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        // UI Elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const maintenanceScreen = document.getElementById('maintenance-screen');
        
        let currentUser = null;
        let isAdmin = false;
        let currentChatUser = null;
        let currentChatId = null;
        let unsubscribeMessages = null;
        
        // New UI elements for responsive layout
        const chatListContainer = document.getElementById('chat-list-container');
        const chatWindowWrapper = document.getElementById('chat-window-wrapper');
        const backToChatsBtn = document.getElementById('back-to-chats-btn');
        const welcomeScreen = document.getElementById('welcome-screen');

        // --- THEME LOGIC ---
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const applyTheme = (theme) => {
            const html = document.documentElement;
            const toggleText = themeToggleButton.querySelector('span');
            const toggleIcon = themeToggleButton.querySelector('i');
            if (theme === 'dark') {
                html.classList.add('dark');
                toggleText.textContent = 'Switch to Light Mode';
                toggleIcon.className = 'fas fa-moon mr-2';
            } else {
                html.classList.remove('dark');
                toggleText.textContent = 'Switch to Dark Mode';
                toggleIcon.className = 'fas fa-sun mr-2';
            }
        };
        themeToggleButton.addEventListener('click', (e) => {
            e.preventDefault();
            const currentTheme = localStorage.getItem('theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });
        // Apply saved theme on initial load
        applyTheme(localStorage.getItem('theme') || 'light');


        // --- Main App Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    isAdmin = userDocSnap.data().isAdmin || false;
                } else {
                    const newUserIsAdmin = user.email === ADMIN_EMAIL;
                    await setDoc(userDocRef, {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.email.split('@')[0],
                        photoURL: `https://ui-avatars.com/api/?name=${user.email.split('@')[0]}&background=random`,
                        isAdmin: newUserIsAdmin
                    });
                    isAdmin = newUserIsAdmin;
                }
                
                setupPresence();
                listenToSiteSettings();
                loadUI();

            } else {
                currentUser = null;
                isAdmin = false;
                showAuthScreen();
            }
        });

        function setupPresence() {
            if (!currentUser) return;
            const userStatusDatabaseRef = ref(rtdb, '/status/' + currentUser.uid);
            const userStatusFirestoreRef = doc(db, 'users', currentUser.uid);
            const isOfflineForRTDB = { state: 'offline' };
                 const isOnlineForRTDB = { state: 'online' };
            const isOfflineForFirestore = { isOnline: false, lastSeen: serverTimestamp() };
            const isOnlineForFirestore = { isOnline: true };
            
            const connectedRef = ref(rtdb, '.info/connected');
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    set(userStatusDatabaseRef, isOnlineForRTDB);
                    updateDoc(userStatusFirestoreRef, isOnlineForFirestore);
                    onDisconnect(userStatusDatabaseRef).set(isOfflineForRTDB).then(() => {
                         updateDoc(userStatusFirestoreRef, isOfflineForFirestore);
                    });
                }
            });
        }
        
        let siteSettings = {};
        function listenToSiteSettings() {
            const settingsDocRef = doc(db, "siteSettings", "config");
            onSnapshot(settingsDocRef, (docSnap) => {
                siteSettings = docSnap.exists() ? docSnap.data() : { maintenanceMode: false, registrationsEnabled: true };

                if (siteSettings.maintenanceMode && !isAdmin) {
                    showMaintenanceScreen();
                } else {
                    if (currentUser) { showMainApp(); }
                    maintenanceScreen.classList.add('hidden');
                }
                
                if (isAdmin){
                    const maintenanceToggle = document.getElementById('maintenance-toggle');
                    const maintenanceStatusText = document.getElementById('maintenance-status-text');
                    maintenanceToggle.checked = siteSettings.maintenanceMode;
                    maintenanceStatusText.textContent = siteSettings.maintenanceMode ? 'ON' : 'OFF';
                    maintenanceStatusText.className = siteSettings.maintenanceMode ? 'text-sm font-semibold text-green-600' : 'text-sm font-semibold text-red-600';
                    
                    const registrationToggle = document.getElementById('registration-toggle');
                    const registrationStatusText = document.getElementById('registration-status-text');
                    registrationToggle.checked = siteSettings.registrationsEnabled;
                    registrationStatusText.textContent = siteSettings.registrationsEnabled ? 'ON' : 'OFF';
                    registrationStatusText.className = siteSettings.registrationsEnabled ? 'text-sm font-semibold text-green-600' : 'text-sm font-semibold text-red-600';
                }
            });
        }

        function loadUI() {
            if (!currentUser) return;
            const userDocRef = doc(db, "users", currentUser.uid);
            onSnapshot(userDocRef, (doc) => {
                 if(doc.exists()) {
                    const userData = doc.data();
                    document.getElementById('user-avatar').src = userData.photoURL || `https://ui-avatars.com/api/?name=${userData.email.split('@')[0]}`;
                 }
            });
            if(isAdmin) { document.getElementById('admin-panel-button').classList.remove('hidden'); }
            loadUserList();
            showMainApp();
            initEmojiPicker();
            // Ensure chat list is visible on initial load, especially for mobile
            chatListContainer.classList.remove('hidden');
        }

        async function loadUserList() {
            const userListEl = document.getElementById('user-list');
            const q = query(collection(db, "users"));
            onSnapshot(q, (snapshot) => {
                userListEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.uid === currentUser.uid) return;
                    
                    const userEl = document.createElement('div');
                    userEl.className = 'flex items-center p-3 hover:bg-theme-tertiary cursor-pointer';
                    userEl.dataset.uid = user.uid;

                    userEl.innerHTML = `
                        <div class="relative">
                            <img src="${user.photoURL}" class="w-12 h-12 rounded-full mr-4">
                            ${user.isOnline ? '<span class="absolute bottom-0 right-4 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></span>' : ''}
                        </div>
                        <div>
                            <h4 class="font-semibold">${user.displayName}</h4>
                            <p class="text-sm text-theme-secondary">${user.isAdmin ? 'Admin' : 'User'}</p>
                        </div>
                    `;
                    userEl.addEventListener('click', () => startChat(user));
                    userListEl.appendChild(userEl);
                });
            });
        }
        
        // Modified startChat to handle responsive layout
        function startChat(otherUser) {
            currentChatUser = otherUser;
            welcomeScreen.classList.add('hidden');
            document.getElementById('chat-window').classList.remove('hidden');
            
            // Show the chat window and hide the user list on small screens
            if (window.innerWidth < 768) {
                chatListContainer.classList.add('hidden');
                chatWindowWrapper.classList.remove('hidden');
            }
            
            document.getElementById('chat-header-avatar').src = otherUser.photoURL;
            document.getElementById('chat-header-name').textContent = otherUser.displayName;
            
            const userStatusRef = ref(rtdb, '/status/' + otherUser.uid);
            onValue(userStatusRef, (snap) => {
                 const statusEl = document.getElementById('chat-header-status');
                 if(snap.exists() && snap.val().state === 'online') {
                    statusEl.textContent = 'Online';
                    statusEl.className = 'text-sm text-green-500';
                 } else {
                    statusEl.textContent = 'Offline';
                    statusEl.className = 'text-sm text-gray-400';
                 }
            });

            const uids = [currentUser.uid, otherUser.uid].sort();
            currentChatId = uids.join('_');
            loadMessages();
        }
        
        function loadMessages() {
            if(unsubscribeMessages) unsubscribeMessages();
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            const messagesRef = collection(db, 'chats', currentChatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp'));

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        displayMessage(change.doc.data());
                    }
                });
            });
        }
        
        function displayMessage(msg) {
            const messagesContainer = document.getElementById('messages-container');
            const isSent = msg.senderUid === currentUser.uid;
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex mb-4 ${isSent ? 'justify-end' : 'justify-start'}`;

            let contentHtml = '';
            switch(msg.type) {
                case 'text': contentHtml = `<p class="whitespace-pre-wrap break-words">${msg.content}</p>`; break;
                case 'image': contentHtml = `<img src="${msg.url}" class="rounded-lg shadow-md cursor-pointer" onclick="window.open('${msg.url}', '_blank')">`; break;
                case 'video': contentHtml = `<video controls src="${msg.url}" class="rounded-lg shadow-md"></video>`; break;
                case 'audio': contentHtml = `<audio controls src="${msg.url}"></audio>`; break;
            }

            const timestamp = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleString() : 'sending...';

            messageWrapper.innerHTML = `
                <div class="max-w-xs lg:max-w-md">
                    <div class="${isSent ? 'message-bubble-sent' : 'message-bubble-received'} p-3 rounded-lg shadow-sm">
                        <div class="message-content">${contentHtml}</div>
                    </div>
                    <p class="text-xs text-theme-secondary mt-1 px-1 ${isSent ? 'text-right' : 'text-left'}">${timestamp}</p>
                </div>
            `;
            messagesContainer.appendChild(messageWrapper);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage(type, content, url = null) {
            if(!currentChatId || (!content && !url)) return;
            const messagesRef = collection(db, 'chats', currentChatId, 'messages');
            await addDoc(messagesRef, { type, content, url, senderUid: currentUser.uid, timestamp: serverTimestamp() });
        }
        
        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', cloudinaryConfig.upload_preset);
            loadingSpinner.classList.remove('hidden');
            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloud_name}/upload`, { method: 'POST', body: formData });
                const data = await response.json();
                if(data.secure_url) {
                    const fileType = file.type.split('/')[0];
                    sendMessage(fileType, file.name, data.secure_url);
                } else { throw new Error('Upload failed'); }
            } catch (error) {
                console.error("Upload Error:", error);
                alert("File upload failed. Please try again.");
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        // --- UI Screens Management ---
        function showAuthScreen() {
            authScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
            maintenanceScreen.classList.add('hidden');
        }
        function showMainApp() {
            authScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            mainApp.classList.add('flex');
            loadingSpinner.classList.add('hidden');
            maintenanceScreen.classList.add('hidden');
            // Show the chat list container by default on main app load
            chatListContainer.classList.remove('hidden');
            chatWindowWrapper.classList.add('hidden');
        }
        function showMaintenanceScreen() {
            authScreen.classList.add('hidden');
            mainApp.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
            maintenanceScreen.classList.remove('hidden');
        }

        // --- Event Listeners ---
        const authForm = document.getElementById('auth-form');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const authError = document.getElementById('auth-error');
        let isLogin = true;

        authToggleLink.addEventListener('click', (e) => {
            e.preventDefault();
            isLogin = !isLogin;
            document.getElementById('auth-title').textContent = isLogin ? 'Login' : 'Sign Up';
            document.getElementById('auth-button').textContent = isLogin ? 'Login' : 'Sign Up';
            document.getElementById('auth-toggle-text').textContent = isLogin ? "Don't have an account?" : "Already have an account?";
            document.getElementById('auth-toggle-link').textContent = isLogin ? 'Sign Up' : 'Login';
            authError.classList.add('hidden');
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingSpinner.classList.remove('hidden');
            authError.classList.add('hidden');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                if(isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    if (!siteSettings.registrationsEnabled) {
                        throw new Error("New user registration is currently disabled.");
                    }
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                authError.textContent = "Authentication Error: " + error.message;
                authError.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        });
        
        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
        
        document.getElementById('user-avatar').addEventListener('click', () => {
             document.getElementById('user-menu').classList.toggle('hidden');
        });
        
        document.getElementById('send-btn').addEventListener('click', () => {
            const input = document.getElementById('message-input');
            if(input.value.trim()){
                sendMessage('text', input.value.trim());
                input.value = '';
            }
        });
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('send-btn').click();
            }
        });
        
        document.getElementById('attach-file-btn').addEventListener('click', () => document.getElementById('file-input').click());
        document.getElementById('file-input').addEventListener('change', (e) => {
            if (e.target.files[0]) uploadFile(e.target.files[0]);
        });
        
        // Voice Message Logic
        let mediaRecorder, audioChunks = [];
        const recordBtn = document.getElementById('record-voice-btn');
        const recordingStatus = document.getElementById('recording-status');
        recordBtn.addEventListener('click', async () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    audioChunks = [];
                    recordingStatus.classList.remove('hidden');
                    recordBtn.classList.add('text-red-500');
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.onstop = () => {
                        recordingStatus.classList.add('hidden');
                        recordBtn.classList.remove('text-red-500');
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioFile = new File([audioBlob], "voice_message.webm", { type: "audio/webm" });
                        uploadFile(audioFile);
                        stream.getTracks().forEach(track => track.stop());
                    };
                } catch(err) { alert("Could not access microphone."); console.error(err); }
            }
        });

        // Delete Chat Logic
        document.getElementById('delete-chat-btn').addEventListener('click', async () => {
            if (!currentChatId || !currentChatUser) return;
            const confirmation = confirm(`Are you sure you want to delete all messages with ${currentChatUser.displayName}? This action cannot be undone.`);
            if (confirmation) {
                loadingSpinner.classList.remove('hidden');
                try {
                    const messagesRef = collection(db, 'chats', currentChatId, 'messages');
                    const querySnapshot = await getDocs(messagesRef);
                    const batch = writeBatch(db);
                    querySnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    document.getElementById('messages-container').innerHTML = '';
                    alert('Chat history deleted successfully.');
                } catch (error) {
                    console.error("Error deleting chat:", error);
                    alert("Failed to delete chat history.");
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            }
        });

        // Emoji Picker Logic
        function initEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            const input = document.getElementById('message-input');
            const emojis = ['ðŸ˜€', 'ðŸ˜‚', 'â¤ï¸', 'ðŸ‘', 'ðŸ˜Š', 'ðŸ™', 'ðŸŽ‰', 'ðŸ˜¢', 'ðŸ”¥', 'ðŸ¤”', 'ðŸ˜Ž', 'ðŸ˜®', 'ðŸ˜‡', 'ðŸ¥³', 'ðŸ’¯', 'ðŸ™Œ'];
            picker.innerHTML = emojis.map(emoji => `<button class="p-1 rounded-full hover:bg-blue-200 text-2xl">${emoji}</button>`).join('');
            picker.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    input.value += btn.textContent;
                    input.focus();
                });
            });
        }
        document.getElementById('emoji-btn').addEventListener('click', () => {
            document.getElementById('emoji-picker').classList.toggle('hidden');
        });

  // Admin Panel Logic
        const adminPanelButton = document.getElementById('admin-panel-button');
        const adminPanel = document.getElementById('admin-panel');
        const closeAdminPanel = document.getElementById('close-admin-panel');
        adminPanelButton.addEventListener('click', (e) => { e.preventDefault(); loadAdminUserList(); adminPanel.classList.remove('hidden'); });
        closeAdminPanel.addEventListener('click', () => adminPanel.classList.add('hidden'));
        
        const settingsDocRef = doc(db, "siteSettings", "config");
        document.getElementById('maintenance-toggle').addEventListener('change', async (e) => {
            await setDoc(settingsDocRef, { maintenanceMode: e.target.checked }, { merge: true });
        });
        document.getElementById('registration-toggle').addEventListener('change', async (e) => {
            await setDoc(settingsDocRef, { registrationsEnabled: e.target.checked }, { merge: true });
        });
        
        document.querySelectorAll('.admin-tab-link').forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                document.querySelectorAll('.admin-tab-link').forEach(l => l.classList.remove('bg-theme-tertiary', 'text-theme-primary', 'font-semibold'));
                link.classList.add('bg-theme-tertiary', 'text-theme-primary', 'font-semibold');
                document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById('admin-tab-' + link.hash.substring(1)).classList.remove('hidden');
            });
        });

        function loadAdminUserList(){
            const userListContainer = document.getElementById('admin-user-list');
            onSnapshot(query(collection(db, "users")), (snapshot) => {
                userListContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const userDiv = document.createElement('div');
                    userDiv.className = 'flex items-center justify-between p-2 bg-theme-tertiary rounded-lg';
                    userDiv.innerHTML = `
                        <div class="flex items-center">
                           <img src="${user.photoURL}" class="w-10 h-10 rounded-full mr-3">
                            <div>
                                <p class="font-medium">${user.displayName}</p>
                                <p class="text-xs text-theme-secondary">${user.email}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button data-uid="${user.uid}" data-isadmin="${user.isAdmin}" class="toggle-admin-btn text-sm px-3 py-1 rounded ${user.isAdmin ? 'bg-indigo-500' : 'bg-gray-500'} text-white">${user.isAdmin ? 'Demote' : 'Promote'}</button>
                            <button data-uid="${user.uid}" class="delete-user-btn text-sm px-3 py-1 rounded bg-red-600 text-white">Delete</button>
                        </div>
                    `;
                    userListContainer.appendChild(userDiv);
                });
            });
        }
        
        // Admin user actions (delegated listener)
        document.getElementById('admin-user-list').addEventListener('click', async (e) => {
            const target = e.target;
            const uid = target.dataset.uid;
            if (!uid || uid === currentUser.uid) return; // Cannot act on self

            if (target.classList.contains('toggle-admin-btn')) {
                const currentIsAdmin = target.dataset.isadmin === 'true';
                if (confirm(`Are you sure you want to ${currentIsAdmin ? 'demote' : 'promote'} this user?`)) {
                    await updateDoc(doc(db, "users", uid), { isAdmin: !currentIsAdmin });
                }
            }
            if (target.classList.contains('delete-user-btn')) {
                 if (confirm(`DANGER: This will delete the user's data from the app. This cannot be undone. Proceed?`)) {
                    // This is a "soft delete" as client-side cannot delete Firebase Auth users.
                    // For a full delete, a Cloud Function is required.
                    await deleteDoc(doc(db, "users", uid));
                    await remove(ref(rtdb, '/status/' + uid));
                    alert("User data has been removed from the application.");
                 }
            }
        });
        
        document.getElementById('chat-with-admin-btn').addEventListener('click', async () => {
            const q = query(collection(db, "users"));
            const snapshot = await getDocs(q);
            let adminUser = null;
            snapshot.forEach(doc => {
                const user = doc.data();
                if(user.isAdmin && user.uid !== currentUser.uid) {
                    adminUser = user;
                }
            });
            if (adminUser) {
                startChat(adminUser);
            } else {
                alert("No available admins to chat with at the moment.");
            }
        });

        // Event listener for the new back button
        backToChatsBtn.addEventListener('click', () => {
            chatListContainer.classList.remove('hidden');
            chatWindowWrapper.classList.add('hidden');
            document.getElementById('chat-window').classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
        });

    </script>
</body>
</html>